<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藍新批次管理 - 全功能整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    <!-- Firebase Compat (預留連線) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .code-font { font-family: 'Fira Code', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .error-cell { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
        .editable-input:focus { background-color: white; box-shadow: 0 0 0 2px #6366f1; outline: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [csvData, setCsvData] = useState([]);
            const [idPrefix, setIdPrefix] = useState('SCR'); // 預設值
            const [zipPassword, setZipPassword] = useState('');
            const [validationStatus, setValidationStatus] = useState('idle');
            const [errorMap, setErrorMap] = useState({});
            const [results, setResults] = useState([]);
            const [selectedJson, setSelectedJson] = useState(null);
            const [processing, setProcessing] = useState(false);
            const [dbRecords, setDbRecords] = useState([]);
            const [cloudConnected, setCloudConnected] = useState(false);

            // 1. 初始化：獲取前綴並嘗試連動 Firebase
            useEffect(() => {
                const init = async () => {
                    // 獲取後端代號前綴 (PartnerID 前三碼)
                    try {
                        const res = await fetch('http://localhost:3000/api/config');
                        const data = await res.json();
                        if (data.prefix) setIdPrefix(data.prefix);
                    } catch (e) { console.warn("未連接後端，使用預設前綴"); }

                    // 嘗試連動 Firebase (僅當佈署後環境變數存在時)
                    try {
                        if (typeof __firebase_config !== 'undefined') {
                            const config = JSON.parse(__firebase_config);
                            if (!firebase.apps.length) firebase.initializeApp(config);
                            await firebase.auth().signInAnonymously();
                            setCloudConnected(true);
                            // 此處可增加 onSnapshot 監聽代碼
                        }
                    } catch (e) { console.log("雲端尚未佈署，監控看板暫不啟用"); }
                };
                init();
            }, []);

            // 2. CSV 解析器
            const parseCSVLine = (text) => {
                const result = [];
                let cell = '', inQuotes = false;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                result.push(cell.trim());
                return result;
            };

            // 3. 檔案處理 (ZIP + CSV)
            const handleZip = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const reader = new zip.ZipReader(new zip.BlobReader(file));
                    const entries = await reader.getEntries();
                    for (const entry of entries) {
                        if (entry.filename.toLowerCase().endsWith('.csv')) {
                            const buf = await entry.getData(new zip.Uint8ArrayWriter(), { password: zipPassword });
                            const text = new TextDecoder('utf-8').decode(buf);
                            const lines = text.split(/\r?\n/).filter(l => l.trim());
                            const headers = parseCSVLine(lines[0]);
                            const data = lines.slice(1).map(l => {
                                const vals = parseCSVLine(l);
                                return headers.reduce((o, h, i) => ({ ...o, [h]: vals[i] || "" }), {});
                            });
                            setCsvData(data);
                            setResults(new Array(data.length).fill(null));
                            setValidationStatus('idle');
                        }
                    }
                    await reader.close();
                } catch (e) { alert("ZIP 解壓失敗，請檢查密碼"); }
            };

            // 4. 線上編輯
            const handleEdit = (idx, field, val) => {
                const next = [...csvData];
                next[idx][field] = val;
                setCsvData(next);
                setValidationStatus('idle');
            };

            // 5. 逐欄檢核 (含英文地址 30 字限制)
            const validate = () => {
                const errors = {};
                csvData.forEach((row, idx) => {
                    if (!row.MerchantName || row.MerchantName.length > 60) errors[`${idx}-MerchantName`] = true;
                    if (!row.MerchantEnAddr || row.MerchantEnAddr.length < 30) errors[`${idx}-MerchantEnAddr`] = true;
                    if (row.MCType === "1" && row.MemberUnified?.length !== 8) errors[`${idx}-MemberUnified`] = true;
                    if (row.MCType === "3" && row.MemberUnified?.length !== 10) errors[`${idx}-MemberUnified`] = true;
                });
                setErrorMap(errors);
                setValidationStatus(Object.keys(errors).length === 0 ? 'passed' : 'failed');
            };

            // 6. 批次執行 (採用後端動態前綴)
            const runBatch = async () => {
                setProcessing(true);
                const timeStr = Math.floor(Date.now() / 1000).toString().slice(-8);
                for (let i = 0; i < csvData.length; i++) {
                    const item = csvData[i];
                    // 生成格式: 前綴(3) + 時間(8) + 序號(3) = 14 字
                    let mid = item.MerchantID || `${idPrefix}${timeStr}${i.toString().padStart(3, '0')}`;
                    try {
                        const res = await fetch('http://localhost:3000/api/create-merchant', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...item, MerchantID: mid })
                        });
                        const data = await res.json();
                        setResults(prev => { const n = [...prev]; n[i] = data; return n; });
                    } catch (e) {
                        setResults(prev => { const n = [...prev]; n[i] = { Status: 'ERROR', Message: 'Proxy 連線失敗' }; return n; });
                    }
                    await new Promise(r => setTimeout(r, 400));
                }
                setProcessing(false);
            };

            return (
                <div className="max-w-[1600px] mx-auto p-6 space-y-6 text-sm">
                    {/* Header */}
                    <header className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-4 rounded-3xl text-white shadow-xl italic font-black text-xl">NP</div>
                            <div>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">藍新商店批次工具</h1>
                                <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1 italic">代號前綴: <span className="text-indigo-600 underline">{idPrefix}</span></p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-3">
                            <input type="password" placeholder="ZIP 密碼" value={zipPassword} onChange={e => setZipPassword(e.target.value)} className="px-4 py-2 bg-slate-50 border rounded-xl outline-none w-32 focus:ring-2 focus:ring-indigo-100" />
                            <div className="relative">
                                <input type="file" onChange={handleZip} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <button className="bg-slate-100 text-slate-600 px-6 py-2.5 rounded-2xl font-bold">1. 匯入 ZIP</button>
                            </div>
                            <button onClick={validate} disabled={csvData.length === 0} className={`px-6 py-2.5 rounded-2xl font-bold border-2 transition-all ${csvData.length === 0 ? 'text-slate-200 border-slate-50' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>2. 檢核</button>
                            <button onClick={runBatch} disabled={processing || validationStatus !== 'passed'} className="bg-indigo-600 text-white px-10 py-2.5 rounded-2xl font-bold shadow-xl shadow-indigo-100 disabled:bg-slate-300">3. 執行批次</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 xl:grid-cols-12 gap-6">
                        {/* 左側：編輯區 */}
                        <div className="xl:col-span-8 bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[700px]">
                            <div className="px-8 py-5 border-b bg-slate-50 font-black text-slate-500 uppercase flex justify-between">
                                <span>批次編輯表單</span>
                                {validationStatus === 'failed' && <span className="text-rose-500 animate-pulse">請修正紅框內容</span>}
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar">
                                <table className="w-full text-left text-xs table-fixed min-w-[1000px]">
                                    <thead className="sticky top-0 bg-white border-b z-10 text-[10px] text-slate-400 font-bold uppercase">
                                        <tr>
                                            <th className="px-6 py-4 w-12">#</th>
                                            <th className="px-4 py-4 w-48">商店名稱 (60)</th>
                                            <th className="px-4 py-4 w-32">證號/統編</th>
                                            <th className="px-4 py-4 w-64">英文地址 (Min 30)</th>
                                            <th className="px-4 py-4 w-24">結果</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {csvData.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="px-6 py-4 text-slate-300 font-mono">{idx + 1}</td>
                                                <td className="px-2 py-2"><input value={row.MerchantName} onChange={e => handleEdit(idx, 'MerchantName', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent editable-input ${errorMap[`${idx}-MerchantName`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-2 py-2"><input value={row.MemberUnified} onChange={e => handleEdit(idx, 'MemberUnified', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent font-mono ${errorMap[`${idx}-MemberUnified`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-2 py-2"><input value={row.MerchantEnAddr} onChange={e => handleEdit(idx, 'MerchantEnAddr', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent text-[10px] ${errorMap[`${idx}-MerchantEnAddr`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-4 py-4">{results[idx] ? <button onClick={() => setSelectedJson(results[idx])} className={`px-2 py-1 rounded font-bold text-[9px] ${results[idx].Status === 'SUCCESS' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>JSON</button> : <span className="text-slate-200 italic">待機</span>}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 右側：預留監控區 */}
                        <div className="xl:col-span-4 bg-slate-900 rounded-[2.5rem] shadow-2xl flex flex-col h-[700px] text-slate-300 overflow-hidden">
                            <div className="px-8 py-6 border-b border-slate-800 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className={`w-2 h-2 rounded-full ${cloudConnected ? 'bg-emerald-500 animate-ping' : 'bg-slate-700'}`}></div>
                                    <span className="text-xs font-black uppercase text-white tracking-widest">Cloud Monitoring</span>
                                </div>
                                <span className="text-[10px] text-slate-500 font-mono">{cloudConnected ? 'CONNECTED' : 'LOCAL_ONLY'}</span>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar p-6 space-y-4">
                                {!cloudConnected ? (
                                    <div className="text-center py-40 text-slate-700 border-2 border-dashed border-slate-800 rounded-[2rem]">
                                        <p className="font-bold text-sm">雲端資料庫尚未佈署</p>
                                        <p className="text-[10px] mt-2 italic px-8">當您將後端上傳至 Render/Railway 並設定 Firebase 變數後，此處將自動啟用實時監控。</p>
                                    </div>
                                ) : (
                                    <div className="text-center text-xs italic">正在等待第一筆雲端記錄...</div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* JSON 解析 Modal */}
                    {selectedJson && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-center justify-center p-6" onClick={() => setSelectedJson(null)}>
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[85%] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="px-10 py-8 border-b flex justify-between items-center bg-slate-50">
                                    <h2 className="text-xl font-black text-slate-800">藍新回應解析</h2>
                                    <button onClick={() => setSelectedJson(null)} className="text-slate-400 hover:text-slate-900 font-black">關閉</button>
                                </div>
                                <div className="flex-1 overflow-auto p-10 code-font text-xs">
                                    <pre className="bg-slate-900 text-indigo-300 p-8 rounded-[2rem] leading-relaxed overflow-x-auto shadow-inner">
                                        {JSON.stringify(selectedJson, null, 4)}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

