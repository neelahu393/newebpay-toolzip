<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藍新金流批次商店工具 (全面檢核版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- zip.js for Password Protected ZIPs -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 自定義圖標組件 (解決 React Error #130)
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const LayersIcon = (props) => (<Icon {...props}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></Icon>);
        const ServerIcon = (props) => (<Icon {...props}><rect x="2" y="2" width="20" height="8" rx="2" ry="2" /><rect x="2" y="14" width="20" height="8" rx="2" ry="2" /><line x1="6" y1="6" x2="6.01" y2="6" /><line x1="6" y1="18" x2="6.01" y2="18" /></Icon>);
        const PackageOpenIcon = (props) => (<Icon {...props}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2Z" /><path d="M12 11v6" /><path d="m9 14 3 3 3-3" /></Icon>);
        const FileArchiveIcon = (props) => (<Icon {...props}><path d="M4 22V4c0-.5.2-1 .6-1.4C5 2.2 5.5 2 6 2h8.5L20 7.5V20c0 .5-.2 1-.6 1.4-.4.4-.9.6-1.4.6h-2" /><polyline points="14 2 14 8 20 8" /><circle cx="10" cy="16" r="2" /><path d="M10 12v2" /><path d="M10 18v2" /></Icon>);
        const LoaderIcon = (props) => (<Icon {...props} className={`animate-spin ${props.className}`}><path d="M21 12a9 9 0 1 1-6.21-8.56" /></Icon>);
        const LockIcon = (props) => (<Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>);
        const AlertIcon = (props) => (<Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></Icon>);
        const CheckIcon = (props) => (<Icon {...props}><polyline points="20 6 9 17 4 12" /></Icon>);

        const App = () => {
            const [proxyUrl, setProxyUrl] = useState('http://localhost:3000/api/create-merchant');
            const [zipPassword, setZipPassword] = useState('');
            const [zipName, setZipName] = useState('');
            const [zipLoading, setZipLoading] = useState(false);
            const [lastZipFile, setLastZipFile] = useState(null);
            const [extractedCsvFiles, setExtractedCsvFiles] = useState([]);
            const [selectedFileName, setSelectedFileName] = useState('');
            
            const [csvData, setCsvData] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [results, setResults] = useState([]);
            const [progress, setProgress] = useState(0);
            const [validationErrors, setValidationErrors] = useState([]);
            const [detectedEncoding, setDetectedEncoding] = useState('尚未偵測'); 
            const [validationStatus, setValidationStatus] = useState('idle');

            const processZip = async (file, password) => {
                if (!file) return;
                setZipLoading(true);
                setExtractedCsvFiles([]);
                handleReset();

                try {
                    const reader = new zip.ZipReader(new zip.BlobReader(file));
                    const entries = await reader.getEntries();
                    const csvList = [];

                    for (const entry of entries) {
                        if (entry.filename.toLowerCase().endsWith('.csv')) {
                            const content = await entry.getData(new zip.Uint8ArrayWriter(), { password });
                            csvList.push({ name: entry.filename, buffer: content });
                        }
                    }
                    await reader.close();

                    if (csvList.length > 0) {
                        setExtractedCsvFiles(csvList);
                        loadCsvFromBuffer(csvList[0].buffer, csvList[0].name);
                    } else {
                        alert("ZIP 檔內找不到任何 CSV 檔案！");
                    }
                } catch (error) {
                    alert("ZIP 解析失敗 (密碼錯誤或檔案損毀)");
                } finally {
                    setZipLoading(false);
                }
            };

            const loadCsvFromBuffer = (buffer, fileName) => {
                setSelectedFileName(fileName);
                let text = "";
                try {
                    const utf8Decoder = new TextDecoder('utf-8', { fatal: true });
                    text = utf8Decoder.decode(buffer);
                    setDetectedEncoding("UTF-8");
                } catch (e) {
                    text = new TextDecoder('big5').decode(buffer);
                    setDetectedEncoding("Big5 (Excel)");
                }

                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) { setCsvData([]); return; }

                const headers = lines[0].split(',').map(h => h.trim());
                const json = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    return headers.reduce((obj, header, index) => {
                        obj[header] = values[index];
                        return obj;
                    }, {});
                });

                setCsvData(json);
                setResults(new Array(json.length).fill({ status: 'pending', message: '等待執行' }));
                setValidationStatus('idle');
                setValidationErrors([]);
            };

            const handleReset = () => {
                setCsvData([]); setResults([]); setValidationStatus('idle'); setValidationErrors([]); setProgress(0);
            };

            // 核心功能：手動逐欄檢核
            const performValidation = () => {
                const errors = [];
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const mobileRegex = /^09\d{8}$/;
                const numericRegex = /^\d+$/;

                csvData.forEach((row, index) => {
                    const rowIdx = index + 1;
                    const merchantName = row.MerchantName || "";
                    const memberUnified = row.MemberUnified || "";
                    const enAddr = row.MerchantEnAddr || "";
                    const mobile = row.ManagerMobile || "";
                    const email = row.MerchantEmail || "";
                    const bankCode = row.BankCode || "";
                    const subBankCode = row.SubBankCode || "";
                    const bankAccount = row.BankAccount || "";

                    // 1. 必填與長度限制
                    if (!merchantName) errors.push({ row: rowIdx, field: "MerchantName", msg: "商店名稱不可為空" });
                    if (merchantName.length > 60) errors.push({ row: rowIdx, field: "MerchantName", msg: "商店名稱不可超過 60 字" });
                    if (!memberUnified) errors.push({ row: rowIdx, field: "MemberUnified", msg: "會員證號不可為空" });

                    // 2. 英文地址限制 (AMR10073)
                    if (!enAddr) {
                        errors.push({ row: rowIdx, field: "MerchantEnAddr", msg: "英文地址不可為空" });
                    } else if (enAddr.length < 30) {
                        errors.push({ row: rowIdx, field: "MerchantEnAddr", msg: `英文地址過短 (${enAddr.length}/30)` });
                    }

                    // 3. 身份類型連動邏輯 (MCType 1=企業, 3=個人)
                    const isEnterprise = row.MCType === "1";
                    if (isEnterprise) {
                        if (memberUnified.length !== 8) errors.push({ row: rowIdx, field: "MemberUnified", msg: "企業型統編需為 8 碼" });
                        if (!row.RepresentName) errors.push({ row: rowIdx, field: "RepresentName", msg: "企業型需提供負責人姓名" });
                        if (!row.CapitalAmount) errors.push({ row: rowIdx, field: "CapitalAmount", msg: "企業型需提供實收資本額" });
                        if (!row.ManagerID) errors.push({ row: rowIdx, field: "ManagerID", msg: "企業型需提供負責人證號 (格式: 1;身分證)" });
                    } else {
                        if (memberUnified.length !== 10) errors.push({ row: rowIdx, field: "MemberUnified", msg: "個人型身分證需為 10 碼" });
                    }

                    // 4. 聯絡資訊格式
                    if (mobile && !mobileRegex.test(mobile)) errors.push({ row: rowIdx, field: "ManagerMobile", msg: "手機需為 09 開頭 10 碼" });
                    if (email && !emailRegex.test(email)) errors.push({ row: rowIdx, field: "MerchantEmail", msg: "Email 格式不正確" });

                    // 5. 金融帳戶格式
                    if (!bankCode || bankCode.length !== 3 || !numericRegex.test(bankCode)) errors.push({ row: rowIdx, field: "BankCode", msg: "銀行代碼需為 3 碼數字" });
                    if (subBankCode && (subBankCode.length !== 4 || !numericRegex.test(subBankCode))) errors.push({ row: rowIdx, field: "SubBankCode", msg: "分行代碼需為 4 碼數字" });
                    if (!bankAccount || bankAccount.length < 10 || bankAccount.length > 14 || !numericRegex.test(bankAccount)) {
                        errors.push({ row: rowIdx, field: "BankAccount", msg: "帳號需為 10-14 碼數字" });
                    }
                });

                setValidationErrors(errors);
                setValidationStatus(errors.length === 0 ? 'passed' : 'failed');
            };

            const runBatch = async () => {
                if (validationStatus !== 'passed') {
                    alert("請先點擊『檢核資料』並確保無誤後再執行。");
                    return;
                }
                setProcessing(true);
                const shortTime = Math.floor(Date.now() / 1000).toString().slice(-8);

                for (let i = 0; i < csvData.length; i++) {
                    const item = csvData[i];
                    setResults(prev => { const next = [...prev]; next[i] = { status: 'loading', message: '傳輸中...' }; return next; });
                    
                    let mid = item.MerchantID;
                    if (!mid || mid.trim() === '') {
                        mid = `SCR${shortTime}${i.toString().padStart(3, '0')}`;
                    }
                    
                    try {
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...item, MerchantID: mid })
                        });
                        const resJson = await response.json();
                        setResults(prev => { 
                            const next = [...prev]; 
                            next[i] = resJson.status === 'SUCCESS' ? { status: 'success', message: `成功: ${mid}` } : { status: 'error', message: resJson.message };
                            return next;
                        });
                    } catch (err) {
                        setResults(prev => { const next = [...prev]; next[i] = { status: 'error', message: '連線 Proxy 失敗' }; return next; });
                    }
                    setProgress(((i + 1) / csvData.length) * 100);
                    await new Promise(r => setTimeout(r, 600));
                }
                setProcessing(false);
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
                    <header className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-3 rounded-2xl shadow-lg text-white"><LayersIcon size={24} /></div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800 tracking-tight">藍新商店批次工具 (手冊規範版)</h1>
                                <p className="text-xs text-slate-400 font-bold uppercase tracking-widest italic">NDNA-1.0.9 Data Compliance</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={performValidation} disabled={csvData.length === 0 || processing} className={`px-6 py-3 rounded-2xl font-bold transition-all border-2 ${csvData.length === 0 ? 'bg-slate-50 text-slate-300 border-slate-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100 hover:bg-emerald-100 active:scale-95'}`}>1. 檢核資料</button>
                            <button onClick={runBatch} disabled={processing || validationStatus !== 'passed'} className={`px-8 py-3 rounded-2xl font-bold text-white transition-all shadow-xl ${processing || validationStatus !== 'passed' ? 'bg-slate-300 shadow-none' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95 shadow-indigo-100'}`}>2. 執行批次</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="space-y-6 text-sm">
                            <section className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm space-y-4">
                                <h3 className="text-xs font-black text-slate-400 flex items-center gap-2 uppercase tracking-widest"><PackageOpenIcon size={14} /> ZIP 檔案匯入</h3>
                                <div className="space-y-1">
                                    <label className="text-[10px] text-slate-400 font-bold uppercase flex items-center gap-1"><LockIcon size={10} /> 解壓密碼</label>
                                    <input type="password" value={zipPassword} onChange={e => setZipPassword(e.target.value)} className="w-full px-4 py-2 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-indigo-100" placeholder="若無請留空" />
                                </div>
                                <div className="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center relative hover:bg-indigo-50/50 transition-all cursor-pointer group">
                                    <input type="file" accept=".zip" onChange={(e) => {
                                        const file = e.target.files[0];
                                        if(!file) return;
                                        setZipName(file.name); setLastZipFile(file);
                                        processZip(file, zipPassword);
                                    }} className="absolute inset-0 opacity-0 cursor-pointer" />
                                    <FileArchiveIcon size={32} className="mx-auto text-slate-300 group-hover:text-indigo-400" />
                                    <span className="text-xs text-slate-500 block font-bold mt-2 truncate px-2">{zipName || '選擇 .zip 檔案'}</span>
                                </div>
                            </section>

                            <section className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                                <h3 className="text-xs font-black text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest"><AlertIcon size={14} /> 規範檢核報告</h3>
                                {validationStatus === 'passed' ? (
                                    <div className="bg-emerald-50 text-emerald-600 p-4 rounded-2xl font-bold border border-emerald-100 flex items-center gap-2">
                                        <CheckIcon size={18} /> 通過手冊規範
                                    </div>
                                ) : validationStatus === 'failed' ? (
                                    <div className="space-y-3">
                                        <div className="bg-rose-50 text-rose-600 p-4 rounded-2xl font-bold border border-rose-100">
                                            發現 {validationErrors.length} 個格式錯誤
                                        </div>
                                        <div className="max-h-60 overflow-y-auto custom-scrollbar space-y-2 p-1">
                                            {validationErrors.map((err, i) => (
                                                <div key={i} className="text-[10px] bg-white border border-rose-100 p-2 rounded-lg shadow-sm">
                                                    <span className="font-bold text-rose-500 mr-2">Row {err.row}</span>
                                                    <span className="text-slate-600">{err.msg}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-slate-300 italic text-center py-4">等待上傳資料...</div>
                                )}
                            </section>
                        </div>

                        <div className="lg:col-span-3 bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                            <div className="px-6 py-5 border-b bg-slate-50/50 flex justify-between items-center text-xs">
                                <div className="flex items-center gap-2">
                                    <span className="font-bold text-slate-500 uppercase">當前檔案:</span>
                                    <span className="font-bold text-indigo-600">{selectedFileName || '尚未選取'}</span>
                                </div>
                                <div className="flex gap-4">
                                    <span className="text-[10px] text-slate-400 font-mono">編碼: {detectedEncoding}</span>
                                    <span className="text-[10px] text-slate-400 font-mono">規則: SCR-15-Limit</span>
                                </div>
                            </div>
                            
                            <div className="flex-1 overflow-auto custom-scrollbar min-h-[500px]">
                                <table className="w-full text-left text-xs">
                                    <thead className="sticky top-0 bg-white border-b z-10 text-[10px] text-slate-400 uppercase font-bold tracking-widest">
                                        <tr>
                                            <th className="px-6 py-4">#</th>
                                            <th className="px-6 py-4">商店資訊</th>
                                            <th className="px-6 py-4">檢核/執行結果</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {csvData.length === 0 ? (
                                            <tr><td colSpan="3" className="px-6 py-40 text-center text-slate-300">請從左側上傳 ZIP 檔案以開始</td></tr>
                                        ) : (
                                            csvData.map((item, idx) => {
                                                const hasError = validationErrors.some(e => e.row === idx + 1);
                                                return (
                                                    <tr key={idx} className={`transition-colors ${hasError ? 'bg-rose-50/30' : 'hover:bg-slate-50/80'}`}>
                                                        <td className="px-6 py-5 text-slate-300 font-mono">{idx + 1}</td>
                                                        <td className="px-6 py-5">
                                                            <div className="font-bold text-slate-700 mb-0.5">{item.MerchantName}</div>
                                                            <div className="flex gap-2 items-center">
                                                                <span className={`text-[9px] px-1.5 py-0.5 rounded font-bold uppercase ${item.MCType === '1' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600'}`}>
                                                                    {item.MCType === '1' ? '企業' : '個人'}
                                                                </span>
                                                                <span className="text-[9px] font-mono text-slate-400">{item.MemberUnified}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-5">
                                                            <div className="flex flex-col gap-1">
                                                                {results[idx]?.status === 'success' ? (
                                                                    <span className="text-emerald-600 font-bold flex items-center gap-1">✓ 成功</span>
                                                                ) : results[idx]?.status === 'error' ? (
                                                                    <span className="text-rose-500 font-bold flex items-center gap-1">✕ 失敗</span>
                                                                ) : results[idx]?.status === 'loading' ? (
                                                                    <span className="text-indigo-500 font-bold animate-pulse">處理中...</span>
                                                                ) : hasError ? (
                                                                    <span className="text-rose-400 font-bold text-[10px] flex items-center gap-1"><AlertIcon size={12}/> 格式有誤</span>
                                                                ) : (
                                                                    <span className="text-slate-200 italic font-normal">等待執行</span>
                                                                )}
                                                                <p className="text-[10px] text-slate-400 leading-tight truncate max-w-[200px]" title={results[idx]?.message}>
                                                                    {results[idx]?.message || (hasError ? "請修正檢核錯誤" : "")}
                                                                </p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            
                            {processing && (
                                <div className="p-4 bg-indigo-600 text-white font-bold text-xs flex items-center justify-between relative overflow-hidden">
                                    <span className="z-10 animate-pulse flex items-center gap-2"><LoaderIcon size={14}/> 批次傳送作業中</span>
                                    <span className="z-10">{Math.round(progress)}%</span>
                                    <div className="absolute bottom-0 left-0 h-1 bg-white/40 transition-all duration-300" style={{width: `${progress}%`}}></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
