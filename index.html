<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藍新金流批次管理系統 - 旗艦版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (用於瀏覽器端解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    <!-- zip.js -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    <!-- Firebase Compat (相容模式) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .code-font { font-family: 'Fira Code', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .error-cell { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
        .editable-input:focus { background-color: white; box-shadow: 0 0 0 2px #6366f1; outline: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
          Upload, FileText, CheckCircle, XCircle, Play, Settings, 
          AlertTriangle, Table: TableIcon, Loader2, ClipboardCheck, 
          AlertCircle, SearchCheck, RotateCcw, Server, ShieldCheck,
          Edit3, Eye, Database, Activity, Lock, Archive, Key
        } = lucideReact;

        const App = () => {
          // 1. 配置與連線狀態
          const [proxyUrl, setProxyUrl] = useState('http://localhost:3000');
          const [idPrefix, setIdPrefix] = useState('SCR');
          const [cloudEnabled, setCloudEnabled] = useState(false);

          // 2. 資料狀態
          const [csvData, setCsvData] = useState([]);
          const [results, setResults] = useState([]);
          const [dbRecords, setDbRecords] = useState([]); 
          const [zipPassword, setZipPassword] = useState('');
          const [validationStatus, setValidationStatus] = useState('idle');
          const [validationErrors, setValidationErrors] = useState([]);
          const [errorMap, setErrorMap] = useState({}); 
          
          // 3. UI 處理狀態
          const [processing, setProcessing] = useState(false);
          const [progress, setProgress] = useState(0);
          const [detectedEncoding, setDetectedEncoding] = useState('尚未偵測');
          const [selectedJson, setSelectedJson] = useState(null);
          const [fileName, setFileName] = useState('');

          // --- 初始化：獲取前綴與 Firebase ---
          useEffect(() => {
            const initSystem = async () => {
              try {
                const res = await fetch(`${proxyUrl}/api/config`);
                const data = await res.json();
                if (data.prefix) setIdPrefix(data.prefix);
              } catch (e) {
                console.warn("無法獲取後端前綴，使用預設 SCR");
              }

              if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                  const config = JSON.parse(__firebase_config);
                  if (!firebase.apps.length) firebase.initializeApp(config);
                  
                  firebase.auth().signInAnonymously().then(() => {
                    setCloudEnabled(true);
                    const db = firebase.firestore();
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                    
                    const collRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('merchant_records');
                    collRef.onSnapshot(snapshot => {
                      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      setDbRecords(data.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0)));
                    });
                  });
                } catch (e) { console.log("Firebase 尚未配置"); }
              }
            };
            initSystem();
          }, [proxyUrl]);

          // --- 解析邏輯 ---
          const processRawText = (text, encodingLabel) => {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return;

            const parseLine = (line) => {
              const result = [];
              let cell = '', inQuotes = false;
              for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                else cell += char;
              }
              result.push(cell.trim());
              return result;
            };

            const headers = parseLine(lines[0]);
            const data = lines.slice(1).map(line => {
              const values = parseLine(line);
              return headers.reduce((obj, header, index) => {
                obj[header] = values[index] || "";
                return obj;
              }, {});
            });

            setCsvData(data);
            setResults(new Array(data.length).fill(null));
            setValidationStatus('idle');
            setValidationErrors([]);
            setErrorMap({});
            setDetectedEncoding(encodingLabel);
          };

          const handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setFileName(file.name);
            if (file.name.toLowerCase().endsWith('.zip')) { handleZipFile(file); } 
            else { handleCsvFile(file); }
            e.target.value = null; 
          };

          const handleCsvFile = (file) => {
            const reader = new FileReader();
            reader.onload = (event) => { decodeAndProcess(new Uint8Array(event.target.result)); };
            reader.readAsArrayBuffer(file);
          };

          const handleZipFile = async (file) => {
            try {
              const reader = new zip.ZipReader(new zip.BlobReader(file));
              const entries = await reader.getEntries();
              const csvEntry = entries.find(e => e.filename.toLowerCase().endsWith('.csv'));
              if (csvEntry) {
                try {
                  const uint8Writer = new zip.Uint8ArrayWriter();
                  const data = await csvEntry.getData(uint8Writer, { password: zipPassword });
                  decodeAndProcess(data);
                } catch (pwErr) { alert("解壓縮失敗：密碼錯誤。"); }
              } else { alert("ZIP 內找不到 CSV。"); }
              await reader.close();
            } catch (err) { alert("ZIP 解析失敗。"); }
          };

          const decodeAndProcess = (uint8) => {
            let text = "";
            let label = "UTF-8";
            const hasBOM = uint8[0] === 0xEF && uint8[1] === 0xBB && uint8[2] === 0xBF;
            try {
              const decoder = new TextDecoder('utf-8', { fatal: true });
              text = decoder.decode(hasBOM ? uint8.slice(3) : uint8);
            } catch (err) {
              text = new TextDecoder('big5').decode(uint8);
              label = "Big5 (Excel)";
            }
            processRawText(text, label);
          };

          const handleCellEdit = (idx, field, val) => {
            const nextData = [...csvData];
            nextData[idx][field] = val;
            setCsvData(nextData);
            setValidationStatus('idle');
          };

          const performValidation = () => {
            setValidationStatus('validating');
            const errors = [];
            const newErrorMap = {};
            const mobileReg = /^09\d{8}$/;
            setTimeout(() => {
              csvData.forEach((row, index) => {
                const rowIdx = index + 1;
                if (!row.MerchantName || row.MerchantName.length > 60) {
                  errors.push({ row: rowIdx, field: "商店名稱", msg: "1-60 字" });
                  newErrorMap[`${index}-MerchantName`] = true;
                }
                if (!row.MerchantEnAddr || row.MerchantEnAddr.length < 30) {
                  errors.push({ row: rowIdx, field: "英文地址", msg: "需滿 30 字" });
                  newErrorMap[`${index}-MerchantEnAddr`] = true;
                }
                if (row.MCType === "1" && row.MemberUnified?.length !== 8) {
                  errors.push({ row: rowIdx, field: "統編", msg: "應為 8 碼" });
                  newErrorMap[`${index}-MemberUnified`] = true;
                }
                if (row.MCType === "3" && row.MemberUnified?.length !== 10) {
                  errors.push({ row: rowIdx, field: "身分證", msg: "應為 10 碼" });
                  newErrorMap[`${index}-MemberUnified`] = true;
                }
                if (row.ManagerMobile && !mobileReg.test(row.ManagerMobile)) {
                  errors.push({ row: rowIdx, field: "手機", msg: "09xxxxxxxx" });
                  newErrorMap[`${index}-ManagerMobile`] = true;
                }
              });
              setValidationErrors(errors);
              setErrorMap(newErrorMap);
              setValidationStatus(errors.length === 0 ? 'passed' : 'failed');
            }, 600);
          };

          const runBatch = async () => {
            if (validationStatus !== 'passed') return;
            setProcessing(true);
            const timeStr = Math.floor(Date.now() / 1000).toString().slice(-8);
            for (let i = 0; i < csvData.length; i++) {
              const item = csvData[i];
              let mid = item.MerchantID || `${idPrefix}${timeStr}${i.toString().padStart(3, '0')}`;
              try {
                const res = await fetch(`${proxyUrl}/api/create-merchant`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ...item, MerchantID: mid })
                });
                const data = await res.json();
                setResults(prev => { const n = [...prev]; n[i] = data; return n; });
              } catch (err) {
                setResults(prev => { const n = [...prev]; n[i] = { Status: 'ERROR', Message: '連線 Proxy 失敗' }; return n; });
              }
              setProgress(((i + 1) / csvData.length) * 100);
              await new Promise(r => setTimeout(r, 400));
            }
            setProcessing(false);
          };

          return (
            <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
              <div className="max-w-[1600px] mx-auto space-y-6">
                <header className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm flex flex-col lg:flex-row justify-between items-center gap-6">
                  <div className="flex items-center gap-5">
                    <div className="bg-indigo-600 p-4 rounded-3xl text-white shadow-xl">
                      <Archive size={32} />
                    </div>
                    <div>
                      <h1 className="text-2xl font-black text-slate-800 tracking-tight">藍新批次管理系統</h1>
                      <div className="flex items-center gap-3 mt-1">
                        <span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-black border border-indigo-100 uppercase tracking-widest">
                          Prefix: {idPrefix}
                        </span>
                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1 ${cloudEnabled ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>
                           {cloudEnabled ? <Activity size={10} className="animate-pulse" /> : <Lock size={10} />}
                           {cloudEnabled ? '雲端即時連動' : '本地測試模式'}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-wrap gap-3 items-end">
                     <div className="flex flex-col">
                        <label className="text-[9px] font-bold text-slate-400 mb-1 ml-1 flex items-center gap-1"><Key size={10}/> ZIP 解壓密碼</label>
                        <input type="password" value={zipPassword} onChange={e => setZipPassword(e.target.value)} placeholder="留空代表無密碼" className="px-4 py-2 bg-slate-50 border rounded-xl text-xs outline-none w-36 focus:ring-2 focus:ring-indigo-100" />
                     </div>
                     <div className="relative mt-auto">
                        <input type="file" accept=".csv,.zip" onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                        <button className="bg-slate-800 text-white px-6 py-2.5 rounded-2xl font-bold text-sm shadow-lg flex items-center gap-2"><Upload size={16} /> 匯入 ZIP / CSV</button>
                     </div>
                     <button onClick={performValidation} disabled={csvData.length === 0} className="mt-auto bg-emerald-50 text-emerald-600 border border-emerald-100 px-6 py-2.5 rounded-2xl font-bold text-sm">2. 檢核規範</button>
                     <button onClick={runBatch} disabled={processing || validationStatus !== 'passed'} className="mt-auto bg-indigo-600 text-white px-10 py-2.5 rounded-2xl font-bold text-sm shadow-xl shadow-indigo-100 disabled:bg-slate-300">3. 開始執行</button>
                  </div>
                </header>

                <div className="grid grid-cols-1 xl:grid-cols-12 gap-6">
                  <div className="xl:col-span-8 bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[750px]">
                    <div className="px-8 py-5 border-b bg-slate-50 flex justify-between items-center">
                      <span className="text-xs font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <TableIcon size={14} /> 當前檔案：{fileName || '尚未匯入'}
                      </span>
                      <span className="text-[9px] text-slate-400 font-mono">ENCODING: {detectedEncoding}</span>
                    </div>
                    <div className="flex-1 overflow-auto custom-scrollbar">
                      <table className="w-full text-left text-xs table-fixed min-w-[1100px]">
                        <thead className="sticky top-0 bg-white border-b z-10 text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                          <tr>
                            <th className="px-6 py-4 w-12">#</th>
                            <th className="px-4 py-4 w-48">商店名稱 (60)</th>
                            <th className="px-4 py-4 w-32">證號/統編</th>
                            <th className="px-4 py-4 w-64">英文地址 (Min 30)</th>
                            <th className="px-4 py-4 w-32">手機號碼</th>
                            <th className="px-4 py-4 w-24 text-center">結果</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {csvData.length === 0 ? (
                            <tr><td colSpan="6" className="py-40 text-center text-slate-300 italic">點擊上方按鈕匯入資料開始編輯</td></tr>
                          ) : (
                            csvData.map((row, idx) => (
                              <tr key={idx} className="hover:bg-slate-50/50 transition-colors">
                                <td className="px-6 py-4 text-slate-300 font-mono font-bold">{idx + 1}</td>
                                <td className="px-2 py-2"><input value={row.MerchantName} onChange={e => handleCellEdit(idx, 'MerchantName', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent focus:bg-white outline-none border border-transparent focus:border-indigo-200 font-bold text-slate-700 ${errorMap[`${idx}-MerchantName`] ? 'error-cell' : ''}`} /></td>
                                <td className="px-2 py-2"><input value={row.MemberUnified} onChange={e => handleCellEdit(idx, 'MemberUnified', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent focus:bg-white outline-none border border-transparent focus:border-indigo-200 font-mono ${errorMap[`${idx}-MemberUnified`] ? 'error-cell' : ''}`} /></td>
                                <td className="px-2 py-2"><input value={row.MerchantEnAddr} onChange={e => handleCellEdit(idx, 'MerchantEnAddr', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent focus:bg-white outline-none border border-transparent focus:border-indigo-200 text-[10px] text-slate-500 ${errorMap[`${idx}-MerchantEnAddr`] ? 'error-cell' : ''}`} /></td>
                                <td className="px-2 py-2"><input value={row.ManagerMobile} onChange={e => handleCellEdit(idx, 'ManagerMobile', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent focus:bg-white outline-none border border-transparent focus:border-indigo-200 font-mono ${errorMap[`${idx}-ManagerMobile`] ? 'error-cell' : ''}`} /></td>
                                <td className="px-4 py-4 text-center">
                                  {results[idx] ? (
                                    <button onClick={() => setSelectedJson(results[idx])} className={`px-2 py-1 rounded font-bold text-[9px] border ${results[idx].Status === 'SUCCESS' ? 'border-emerald-200 text-emerald-600 bg-emerald-50' : 'border-rose-200 text-rose-600 bg-rose-50'}`}>JSON</button>
                                  ) : <span className="text-slate-200 italic">待機</span>}
                                </td>
                              </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div className="xl:col-span-4 bg-slate-900 rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[750px] text-slate-300">
                    <div className="px-8 py-6 border-b border-slate-800 flex justify-between items-center">
                      <div className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${cloudEnabled ? 'bg-emerald-500 animate-ping' : 'bg-slate-700'}`}></div>
                        <span className="text-xs font-black uppercase text-white tracking-widest">Firestore Feed</span>
                      </div>
                    </div>
                    <div className="flex-1 overflow-auto custom-scrollbar p-6 space-y-4">
                      {!cloudEnabled ? (
                        <div className="text-center py-40 text-slate-700 border-2 border-dashed border-slate-800 rounded-[2rem] px-10 text-[10px] italic">雲端監控尚未就緒</div>
                      ) : (
                        dbRecords.map(rec => (
                          <div key={rec.id} className="bg-white/5 p-4 rounded-3xl">
                            <div className="text-[10px] text-indigo-400">{rec.updatedAt?.toDate().toLocaleTimeString()}</div>
                            <div className="text-xs font-bold text-white truncate">{rec.merchantName}</div>
                            <div className="text-[9px] text-slate-500">{rec.merchantID}</div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {selectedJson && (
                <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-50 flex items-center justify-center p-6" onClick={() => setSelectedJson(null)}>
                  <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[85%] flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="px-10 py-8 border-b flex justify-between items-center">
                      <h2 className="text-xl font-black text-slate-800">API 回應解析</h2>
                      <button onClick={() => setSelectedJson(null)} className="text-slate-400 font-black">關閉</button>
                    </div>
                    <div className="flex-1 overflow-auto p-10 code-font text-xs">
                      <pre className="bg-slate-900 text-indigo-300 p-8 rounded-[2rem] overflow-x-auto">
                        {JSON.stringify(selectedJson, null, 4)}
                      </pre>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


