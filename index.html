<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藍新批次管理 - DB Monitor Fix</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- zip.js -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    
    <!-- Firebase SDK (使用 Compat 版本以確保全域變數可用) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .error-cell { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SVG 圖標組件 ---
        const Icon = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const DatabaseIcon = () => <Icon><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>;
        const AlertIcon = () => <Icon className="text-rose-500"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const CheckIcon = () => <Icon className="text-emerald-500"><polyline points="20 6 9 17 4 12"/></Icon>;

        const App = () => {
            const [fbStatus, setFbStatus] = useState({ loading: true, error: null });
            const [user, setUser] = useState(null);
            const [dbRecords, setDbRecords] = useState([]);
            
            const [proxyUrl, setProxyUrl] = useState('http://localhost:3000/api/create-merchant');
            const [zipPassword, setZipPassword] = useState('');
            const [csvData, setCsvData] = useState([]);
            const [processing, setProcessing] = useState(false);
            const [results, setResults] = useState([]);
            const [validationStatus, setValidationStatus] = useState('idle');

            // 1. 初始化 Firebase (Compat 模式)
            useEffect(() => {
                try {
                    const config = JSON.parse(__firebase_config);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(config);
                    }

                    const auth = firebase.auth();
                    const db = firebase.firestore();

                    // 匿名登入
                    auth.signInAnonymously().then(cred => {
                        setUser(cred.user);
                        setFbStatus({ loading: false, error: null });
                        
                        // 監聽資料庫 (遵從 Rule 1: /artifacts/{appId}/public/data/merchant_records)
                        const collRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('merchant_records');
                        
                        collRef.onSnapshot(snapshot => {
                            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // 在前端按時間排序 (遵從 Rule 2: 不使用複雜查詢)
                            const sorted = items.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                            setDbRecords(sorted);
                        }, err => {
                            console.error("Firestore 監聽失敗:", err);
                        });

                    }).catch(err => {
                        setFbStatus({ loading: false, error: "Firebase 登入失敗: " + err.message });
                    });

                } catch (err) {
                    setFbStatus({ loading: false, error: "Firebase 初始化錯誤: " + err.message });
                }
            }, []);

            // 2. CSV 解析器
            const parseCSVLine = (text) => {
                const result = [];
                let cell = '', inQuotes = false;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                result.push(cell.trim());
                return result;
            };

            const handleZipUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const reader = new zip.ZipReader(new zip.BlobReader(file));
                    const entries = await reader.getEntries();
                    for (const entry of entries) {
                        if (entry.filename.toLowerCase().endsWith('.csv')) {
                            const content = await entry.getData(new zip.Uint8ArrayWriter(), { password: zipPassword });
                            const text = new TextDecoder('utf-8').decode(content);
                            const lines = text.split(/\r?\n/).filter(l => l.trim());
                            const headers = parseCSVLine(lines[0]);
                            const data = lines.slice(1).map(l => {
                                const vals = parseCSVLine(l);
                                return headers.reduce((o, h, i) => ({ ...o, [h]: vals[i] || "" }), {});
                            });
                            setCsvData(data);
                            setResults(new Array(data.length).fill(null));
                            setValidationStatus('idle');
                        }
                    }
                    await reader.close();
                } catch (err) { alert("ZIP 解析失敗，請檢查密碼"); }
            };

            const runBatch = async () => {
                setProcessing(true);
                const shortTime = Math.floor(Date.now() / 1000).toString().slice(-8);
                for (let i = 0; i < csvData.length; i++) {
                    const item = csvData[i];
                    let mid = item.MerchantID || `SCR${shortTime}${i.toString().padStart(3, '0')}`;
                    try {
                        const res = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...item, MerchantID: mid })
                        });
                        const data = await res.json();
                        setResults(prev => { const n = [...prev]; n[i] = data; return n; });
                    } catch (e) {
                        setResults(prev => { const n = [...prev]; n[i] = { status: 'ERROR', message: '連線代理伺服器失敗' }; return n; });
                    }
                    await new Promise(r => setTimeout(r, 500));
                }
                setProcessing(false);
            };

            // 如果 Firebase 還在載入或出錯
            if (fbStatus.loading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-6">
                        <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="font-bold animate-pulse text-indigo-300">正在連接雲端監控中心...</p>
                    </div>
                );
            }

            if (fbStatus.error) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6">
                        <div className="bg-white p-8 rounded-[2.5rem] shadow-xl border border-rose-100 max-w-md text-center">
                            <div className="bg-rose-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 text-rose-500">
                                <AlertIcon size={32} />
                            </div>
                            <h2 className="text-xl font-black text-slate-800 mb-2">啟動失敗</h2>
                            <p className="text-slate-500 text-sm mb-6">{fbStatus.error}</p>
                            <button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-8 py-3 rounded-2xl font-bold">重新整理</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
                    {/* Header */}
                    <header className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg"><DatabaseIcon /></div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800 tracking-tight">藍新商店監控中心 <span className="text-indigo-600">v5.1</span></h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Firebase Live Feed Connected</p>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <input type="password" placeholder="ZIP 密碼" value={zipPassword} onChange={e => setZipPassword(e.target.value)} className="px-4 py-2 bg-slate-50 border rounded-xl text-xs outline-none w-28" />
                            <div className="relative">
                                <input type="file" onChange={handleZipUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <button className="bg-slate-100 text-slate-600 px-6 py-2 rounded-xl font-bold text-xs hover:bg-slate-200 transition-colors">上傳 ZIP</button>
                            </div>
                            <button onClick={runBatch} disabled={csvData.length === 0 || processing} className="bg-indigo-600 text-white px-8 py-2 rounded-xl font-bold text-xs shadow-lg shadow-indigo-100 disabled:bg-slate-300">執行批次</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* 左側：資料庫歷程監控 */}
                        <div className="lg:col-span-2 bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col h-[650px] overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                                <span className="text-xs font-bold text-slate-500 flex items-center gap-2"><div className="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></div> 雲端紀錄同步中 (Firestore)</span>
                                <span className="text-[10px] text-slate-400 font-mono">UID: {user?.uid.slice(0, 8)}...</span>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar">
                                <table className="w-full text-left text-xs">
                                    <thead className="sticky top-0 bg-white border-b z-10 text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                                        <tr>
                                            <th className="px-6 py-4">商店/代號</th>
                                            <th className="px-6 py-4">API 回應</th>
                                            <th className="px-6 py-4">Webhook 審核結果</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {dbRecords.length === 0 ? (
                                            <tr><td colSpan="3" className="px-6 py-40 text-center text-slate-300 italic">尚未在雲端發現任何記錄</td></tr>
                                        ) : (
                                            dbRecords.map(rec => (
                                                <tr key={rec.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-6 py-4">
                                                        <div className="font-bold text-slate-700">{rec.merchantName}</div>
                                                        <div className="text-[10px] text-slate-400 font-mono mt-0.5">{rec.merchantID}</div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className={`px-2 py-0.5 rounded-full font-bold text-[9px] ${rec.syncStatus === 'SUCCESS' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-500'}`}>
                                                            {rec.syncStatus}
                                                        </span>
                                                        <p className="text-[10px] text-slate-400 mt-1 truncate max-w-[150px]">{rec.syncMessage}</p>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        {rec.webhookStatus ? (
                                                            <div className="flex flex-col gap-1">
                                                                <span className={`font-bold ${rec.webhookStatus === 'SUCCESS' ? 'text-indigo-600' : 'text-orange-500'}`}>
                                                                    [{rec.webhookStatus}]
                                                                </span>
                                                                <span className="text-[10px] text-slate-500 italic">{rec.webhookMessage}</span>
                                                            </div>
                                                        ) : (
                                                            <span className="text-slate-300 italic animate-pulse">審核中...</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 右側：本地 CSV 編輯與狀態 */}
                        <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm flex flex-col h-[650px] overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                                <span className="text-xs font-bold text-slate-500">待傳送清單</span>
                                <span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full font-bold">{csvData.length} 筆</span>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar p-4 space-y-3 bg-slate-50/30">
                                {csvData.length === 0 ? (
                                    <div className="text-center py-20 text-slate-300 text-xs italic">請先上傳 ZIP 檔案</div>
                                ) : (
                                    csvData.map((row, idx) => (
                                        <div key={idx} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm transition-all hover:border-indigo-300">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="text-[10px] font-mono text-slate-300"># {idx + 1}</span>
                                                {results[idx] ? (
                                                    <span className={`text-[9px] font-bold px-2 py-0.5 rounded-full ${results[idx].status === 'SUCCESS' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>
                                                        {results[idx].status}
                                                    </span>
                                                ) : <span className="text-[9px] bg-slate-50 text-slate-300 px-2 py-0.5 rounded-full italic">等待中</span>}
                                            </div>
                                            <div className="font-bold text-slate-700 text-sm mb-1">{row.MerchantName}</div>
                                            <div className="text-[10px] text-slate-400 font-mono flex gap-2">
                                                <span className="bg-slate-100 px-1 rounded">{row.MCType === '1' ? '企業' : '個人'}</span>
                                                {row.MemberUnified}
                                            </div>
                                            {results[idx] && <p className="text-[10px] text-slate-400 mt-2 border-t pt-2 italic">{results[idx].message}</p>}
                                        </div>
                                    ))
                                )}
                            </div>
                            {processing && (
                                <div className="p-4 bg-indigo-600 text-white font-bold text-[10px] flex justify-between items-center relative overflow-hidden">
                                    <span className="z-10 animate-pulse">批次引擎傳輸中</span>
                                    <span className="z-10">{Math.round(progress)}%</span>
                                    <div className="absolute bottom-0 left-0 h-1 bg-white/40 transition-all z-0" style={{width: `${progress}%`}}></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


