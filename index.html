<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藍新批次管理 - 全功能前綴同步版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- zip.js -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .code-font { font-family: 'Fira Code', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .error-cell { border: 2px solid #ef4444 !important; background-color: #fef2f2; }
        .editable-input:focus { background-color: white; box-shadow: 0 0 0 2px #6366f1; outline: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const App = () => {
            const [fbReady, setFbReady] = useState(false);
            const [dbRecords, setDbRecords] = useState([]);
            const [csvData, setCsvData] = useState([]);
            const [idPrefix, setIdPrefix] = useState('SCR'); // 預設值，將由後端獲取
            const [zipPassword, setZipPassword] = useState('');
            const [validationStatus, setValidationStatus] = useState('idle');
            const [errorMap, setErrorMap] = useState({});
            const [results, setResults] = useState([]);
            const [selectedJson, setSelectedJson] = useState(null);
            const [processing, setProcessing] = useState(false);
            const [proxyUrl, setProxyUrl] = useState('http://localhost:3000/api/create-merchant');

            // 1. 初始化時獲取後端前綴與 Firebase
            useEffect(() => {
                const init = async () => {
                    // 獲取後端 PartnerID 前綴
                    try {
                        const configRes = await fetch('http://localhost:3000/api/config');
                        const configData = await configRes.json();
                        if (configData.prefix) setIdPrefix(configData.prefix);
                    } catch (e) { console.warn("無法連接後端獲取前綴，使用預設 SCR"); }

                    // 初始化 Firebase
                    try {
                        const config = JSON.parse(__firebase_config);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        
                        await firebase.auth().signInAnonymously();
                        const db = firebase.firestore();
                        const collRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('merchant_records');
                        
                        collRef.onSnapshot(snapshot => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setDbRecords(data.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0)));
                            setFbReady(true);
                        });
                    } catch (e) { console.error("Firebase 初始化失敗", e); }
                };
                init();
            }, []);

            // 2. CSV 解析邏輯
            const parseCSVLine = (text) => {
                const result = [];
                let cell = '', inQuotes = false;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                result.push(cell.trim());
                return result;
            };

            // 3. ZIP 密碼解壓縮
            const handleZip = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const reader = new zip.ZipReader(new zip.BlobReader(file));
                    const entries = await reader.getEntries();
                    for (const entry of entries) {
                        if (entry.filename.toLowerCase().endsWith('.csv')) {
                            const buf = await entry.getData(new zip.Uint8ArrayWriter(), { password: zipPassword });
                            const text = new TextDecoder('utf-8').decode(buf);
                            const lines = text.split(/\r?\n/).filter(l => l.trim());
                            const headers = parseCSVLine(lines[0]);
                            const data = lines.slice(1).map(l => {
                                const vals = parseCSVLine(l);
                                return headers.reduce((o, h, i) => ({ ...o, [h]: vals[i] || "" }), {});
                            });
                            setCsvData(data);
                            setResults(new Array(data.length).fill(null));
                            setValidationStatus('idle');
                            setErrorMap({});
                        }
                    }
                    await reader.close();
                } catch (e) { alert("ZIP 解析失敗或密碼錯誤"); }
            };

            // 4. 線上編輯
            const handleEdit = (idx, field, val) => {
                const next = [...csvData];
                next[idx][field] = val;
                setCsvData(next);
                setValidationStatus('idle');
            };

            // 5. 逐欄手冊規範檢核
            const validate = () => {
                const errors = {};
                const mobileReg = /^09\d{8}$/;
                csvData.forEach((row, idx) => {
                    if (!row.MerchantName || row.MerchantName.length > 60) errors[`${idx}-MerchantName`] = true;
                    if (!row.MerchantEnAddr || row.MerchantEnAddr.length < 30) errors[`${idx}-MerchantEnAddr`] = true;
                    if (row.MCType === "1" && row.MemberUnified?.length !== 8) errors[`${idx}-MemberUnified`] = true;
                    if (row.MCType === "3" && row.MemberUnified?.length !== 10) errors[`${idx}-MemberUnified`] = true;
                    if (!mobileReg.test(row.ManagerMobile)) errors[`${idx}-ManagerMobile`] = true;
                });
                setErrorMap(errors);
                setValidationStatus(Object.keys(errors).length === 0 ? 'passed' : 'failed');
            };

            // 6. 批次執行 (使用後端同步的前綴)
            const runBatch = async () => {
                setProcessing(true);
                const timeStr = Math.floor(Date.now() / 1000).toString().slice(-8);
                for (let i = 0; i < csvData.length; i++) {
                    const item = csvData[i];
                    // 根據手冊規範組年代號: Prefix (後端獲取) + 8位時間 + 3位序號
                    let mid = item.MerchantID || `${idPrefix}${timeStr}${i.toString().padStart(3, '0')}`;
                    try {
                        const res = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ...item, MerchantID: mid })
                        });
                        const data = await res.json();
                        setResults(prev => { const n = [...prev]; n[i] = data; return n; });
                    } catch (e) {
                        setResults(prev => { const n = [...prev]; n[i] = { Status: 'ERROR', Message: 'Proxy 連線失敗' }; return n; });
                    }
                    await new Promise(r => setTimeout(r, 400));
                }
                setProcessing(false);
            };

            return (
                <div className="max-w-[1600px] mx-auto p-6 space-y-6">
                    <header className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 flex flex-col lg:flex-row justify-between items-center gap-6">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-4 rounded-3xl text-white shadow-xl">
                                <Icon size={28}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></Icon>
                            </div>
                            <div>
                                <h1 className="text-2xl font-black text-slate-800 tracking-tight">藍新批次管理系統 <span className="text-indigo-600 font-medium">旗艦版</span></h1>
                                <p className="text-xs text-slate-400 font-bold uppercase mt-1">代號自動生成前綴: <span className="text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{idPrefix}</span> (同步自 PartnerID)</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-3">
                            <input type="password" placeholder="ZIP 密碼" value={zipPassword} onChange={e => setZipPassword(e.target.value)} className="px-4 py-2 bg-slate-50 border rounded-xl text-sm outline-none w-32 focus:ring-2 focus:ring-indigo-100" />
                            <div className="relative">
                                <input type="file" onChange={handleZip} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <button className="bg-slate-100 text-slate-600 px-6 py-2.5 rounded-2xl font-bold text-sm">1. 匯入 ZIP</button>
                            </div>
                            <button onClick={validate} disabled={csvData.length === 0} className={`px-6 py-2.5 rounded-2xl font-bold text-sm border-2 transition-all ${csvData.length === 0 ? 'border-slate-100 text-slate-300' : 'border-emerald-100 bg-emerald-50 text-emerald-600 hover:bg-emerald-100'}`}>2. 檢核</button>
                            <button onClick={runBatch} disabled={processing || validationStatus !== 'passed'} className="bg-indigo-600 text-white px-10 py-2.5 rounded-2xl font-bold text-sm shadow-xl shadow-indigo-100 disabled:bg-slate-300 transform active:scale-95 transition-all">3. 開始執行</button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 xl:grid-cols-12 gap-6">
                        {/* 左側：編輯與即時發送 */}
                        <div className="xl:col-span-8 bg-white rounded-[2.5rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[700px]">
                            <div className="px-8 py-5 border-b bg-slate-50 flex justify-between items-center text-xs font-black text-slate-500 uppercase tracking-widest">
                                <span>批次編輯表單 (預計生成格式: {idPrefix}XXXXXXXXXXX)</span>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar">
                                <table className="w-full text-left text-xs table-fixed min-w-[1000px]">
                                    <thead className="sticky top-0 bg-white border-b z-10 text-[10px] text-slate-400 font-bold uppercase">
                                        <tr>
                                            <th className="px-6 py-4 w-12">#</th>
                                            <th className="px-4 py-4 w-48">商店名稱 (60)</th>
                                            <th className="px-4 py-4 w-32">證號/統編</th>
                                            <th className="px-4 py-4 w-64">英文地址 (Min 30)</th>
                                            <th className="px-4 py-4 w-24">同步回應</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {csvData.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50/50 transition-colors">
                                                <td className="px-6 py-4 text-slate-300 font-mono">{idx + 1}</td>
                                                <td className="px-2 py-2"><input value={row.MerchantName} onChange={e => handleEdit(idx, 'MerchantName', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent editable-input ${errorMap[`${idx}-MerchantName`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-2 py-2"><input value={row.MemberUnified} onChange={e => handleEdit(idx, 'MemberUnified', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent font-mono ${errorMap[`${idx}-MemberUnified`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-2 py-2"><input value={row.MerchantEnAddr} onChange={e => handleEdit(idx, 'MerchantEnAddr', e.target.value)} className={`w-full px-3 py-2 rounded-xl bg-transparent text-[10px] ${errorMap[`${idx}-MerchantEnAddr`] ? 'error-cell' : ''}`} /></td>
                                                <td className="px-4 py-4">
                                                    {results[idx] ? (
                                                        <button onClick={() => setSelectedJson(results[idx])} className={`px-2 py-1 rounded font-bold text-[9px] ${results[idx].Status === 'SUCCESS' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>JSON</button>
                                                    ) : <span className="text-slate-200">待執行</span>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* 右側：雲端即時歷程看板 */}
                        <div className="xl:col-span-4 bg-slate-900 rounded-[2.5rem] shadow-2xl flex flex-col h-[700px] text-slate-300 overflow-hidden">
                            <div className="px-8 py-6 border-b border-slate-800 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></div>
                                    <span className="text-xs font-black uppercase text-white tracking-widest">Firestore Live Feed</span>
                                </div>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar p-6 space-y-4">
                                {dbRecords.length === 0 ? (
                                    <div className="text-center py-40 text-slate-600 italic">無雲端紀錄</div>
                                ) : (
                                    dbRecords.map(rec => (
                                        <div key={rec.id} className="bg-white/5 border border-white/5 p-4 rounded-3xl group hover:bg-white/10 transition-all">
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="text-[10px] text-indigo-400 font-mono">{rec.updatedAt?.toDate().toLocaleTimeString()}</div>
                                                <span className={`px-2 py-0.5 rounded-full text-[9px] font-bold ${rec.webhookStatus === 'SUCCESS' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}`}>
                                                    {rec.webhookStatus ? '審核完畢' : '已同步傳送'}
                                                </span>
                                            </div>
                                            <div className="text-xs font-bold text-white truncate">{rec.merchantName}</div>
                                            <div className="text-[9px] text-slate-500 font-mono mt-1">{rec.merchantID}</div>
                                            <button onClick={() => setSelectedJson(rec.webhookRaw || rec.syncRaw)} className="mt-3 text-[9px] text-slate-500 underline opacity-0 group-hover:opacity-100 transition-opacity">解析原始資料</button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>

                    {/* JSON 解析視窗 */}
                    {selectedJson && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-center justify-center p-6" onClick={() => setSelectedJson(null)}>
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden max-h-[85%] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="px-10 py-8 border-b flex justify-between items-center bg-slate-50">
                                    <h2 className="text-xl font-black text-slate-800">回應 JSON 解析</h2>
                                    <button onClick={() => setSelectedJson(null)} className="text-slate-400 hover:text-slate-900 font-black">關閉</button>
                                </div>
                                <div className="flex-1 overflow-auto p-10 code-font text-xs">
                                    <pre className="bg-slate-900 text-indigo-300 p-8 rounded-[2rem] leading-relaxed overflow-x-auto shadow-inner">
                                        {JSON.stringify(selectedJson, null, 4)}
                                    </pre>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>





